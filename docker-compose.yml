services:
  mcp:
    build: .
    container_name: ${MCP_SERVER_NAME:-mcp-server}
    ports:
      - "${PORT:-8081}:80"
    volumes:
      - ./src:/app/src
      - ./composer.json:/app/composer.json
      - ./composer.lock:/app/composer.lock
      - ./vendor:/app/vendor
      - mcp-sessions:/app/storage/mcp-sessions
    env_file:
      - .env
    environment:
      - MCP_SERVER_NAME=${MCP_SERVER_NAME:-mcp-server}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_VERSION=${APP_VERSION:-1.0.0}
    restart: unless-stopped
    depends_on:
      - redis
      - mongodb
      - memgraph

  dev:
    build:
      context: .
      target: build
      args:
        VERSION: ${APP_VERSION:-0.0.0-dev}
    container_name: mcp-server-dev
    ports:
      - "8085:80"
    volumes:
      - .:/app
      - ./Caddyfile:/etc/frankenphp/Caddyfile:ro
    environment:
      - APP_DEBUG=true
      - APP_VERSION=${APP_VERSION:-0.0.0-dev}
      - MCP_SERVER_NAME=mcp-server-dev
    command: frankenphp run --config /etc/frankenphp/Caddyfile
    depends_on:
      - redis
      - mongodb
      - memgraph
    profiles:
      - dev

  prod:
    build:
      context: .
      args:
        VERSION: ${APP_VERSION:-1.0.0}
    container_name: mcp-server-prod
    ports:
      - "8081:80"
    volumes:
      - ./src:/app/src
      - mcp-sessions-prod:/app/storage/mcp-sessions
    env_file:
      - .env
    environment:
      - MCP_SERVER_NAME=${MCP_SERVER_NAME:-mcp-server}
      - APP_DEBUG=${APP_DEBUG:-false}
    restart: unless-stopped
    depends_on:
      - redis
      - mongodb
      - memgraph
    profiles:
      - prod

  composer:
    build:
      target: build
    volumes:
      - .:/app
    profiles:
      - composer

  redis:
    image: redis:7-alpine
    container_name: ${MCP_SERVER_NAME:-mcp}-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes

  mongodb:
    image: mongo:8
    container_name: ${MCP_SERVER_NAME:-mcp}-mongodb
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb-data:/data/db
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_USERNAME:-}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD:-}

  memgraph:
    image: memgraph/memgraph-platform:latest
    container_name: ${MCP_SERVER_NAME:-mcp}-memgraph
    ports:
      - "${MEMGRAPH_PORT:-7687}:7687"
      - "${MEMGRAPH_LAB_PORT:-3000}:3000"
    volumes:
      - memgraph-data:/var/lib/memgraph
    restart: unless-stopped
    environment:
      - MEMGRAPH=--log-level=WARNING

volumes:
  mcp-sessions:
  mcp-sessions-prod:
  redis-data:
  mongodb-data:
  memgraph-data: